---
title: "Tobin Predoctoral Data Task"
subtitle: "Experiments to Enhance the Efficiency of Medicaid"
author: "Sheena Tan"

date: today

format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    embed-resources: true
    code-fold: false
    link-external-newwindow: true

execute:
  warning: false
  
from: markdown+emoji
reference-location: margin
citation-location: margin
---

::: {.callout-tip icon="false"}
## Github Repo Link

<https://github.com/sheena-tan/tobintask.git>
:::

# Introduction

This project uses data provided by Yale's Tobin Center for Economic Policy as part of a data task for a pre-doctoral research position. The data draws from a larger research project aiming to understand hospital response to reimbursement rate adjustment received as part of the Medicare Modernization Act (MMA) of 2003, and whether their adoption of medical technologies increased as a result of those adjustments for Task 1. Task 2 uses data... TKTK ...

## Task 1

### Exercise 1

::: {.callout-note collapse=true icon=false}
## CODE FOR REPRODUCIBILITY

```{r, eval = FALSE}
skimr::skim(mma_main)
skimr::skim(mma_treat)
# check missingness: n_missing = 0 for all variables
# check duplicates: n_unique = 1305 for both datasets

# Clean primary key ----
mma_main_join <- mma_main |>
  mutate(prov_id = tolower(prov_id))

mma_treat_join <- mma_treat |>
  mutate(prov_id = tolower(prov_id))

# Join data ----
mma_data <- mma_treat_join |>
  left_join(mma_main_join)

```

:::

An initial inspection of the data revealed no missingness. The provided data files were joined using provider ID as a primary key, resulting in a merged dataset with 13050 unique observations of 38 variables.

### Exercise 2

::: {.callout-note collapse=true icon=false}
## CODE FOR REPRODUCIBILITY

```{r, eval = FALSE}
mma_data |>
  group_by(year) |>
  mutate(prov_total = n_distinct(prov_id)) |>
  skimr::skim(prov_total)
# N_t each year [2001-2010] constant = 1305

# create intermediate index variable before sum for all `tech_n`
for (i in 1:31) {
  mma_saidin <- mma_saidin |>
    group_by(year) |>
    mutate(
      # number of hospitals with tech_n
      !!paste0("sum_", i) := sum(!!sym(paste0("tech_", i))), 
      # weight a_k,t
      !!paste0("weight_", i) := 1 - (1/1305) * !!sym(paste0("sum_", i)), 
      !!paste0("index_", i) := 
        !!sym(paste0("tech_", i)) * !!sym(paste0("weight_", i))
    )
}

# sum across `index_n` to find saidin index for each hospital per year
mma_saidin <- mma_saidin |>
  pivot_longer(cols = starts_with("index"), names_to = "index") |>
  group_by(prov_id, year) |>
  summarise(sum(value)) |>
  rename(saidin = `sum(value)`)

# join to merged data
mma_data <- mma_saidin |>
  left_join(mma_data)

```

:::

A variable `saidin` was constructed to represent the Saidin Index Score[^1] for all hospitals in each year and joined with the merged dataset to create the working dataset with **13050 observations** of **39 variables**. This index characterizes a hospital's range of available technologies, weighted for their rarity, and provides a way through which to investigate how hospital technology grows and changes, particularly in response to interventions.

[^1]: Baker, L. & Spetz, J. (1999). Managed care and medical technology growth. *Frontiers in Health
Policy Research, 2*, 31.

### Exercise 3

#### Part A

::: {.callout-note collapse=true icon=false}
## CODE FOR REPRODUCIBILITY

```{r, eval = FALSE}
mma_2004 <- mma_data |> 
  filter(year == 2004)

describe(mma_2004$saidin, IQR = TRUE, skew = FALSE)
```

:::

::: {.callout-note icon=false appearance="simple"}
# Summary Statistics
```{r, echo = FALSE}
library(psych)
library(dplyr)
library(here)
load(here("task1/data/mma_data.rds"))
mma_2004 <- mma_data |> 
  filter(year == 2004)
describe(mma_2004$saidin, IQR = TRUE, skew = FALSE)
```

:::

The distribution of Saidin Index scores in 2004 is strongly right-skewed, with values ranging from **0 to 11.57**, a **median of 1.19**, and an **IQR of 1.84**. 

![Density-boxplot of Saidin Index scores in 2004](task1/figures/saidin_2004.png){#fig-1}

As the Saidin Index is helpful for characterizing technology growth rates, the distributions by year can also be found below:

::: {.callout-tip collapse=true}
## ADDITIONAL EXPLORATORY ANALYSIS

![Density ridge plot of Saidin Index scores by year](task1/figures/saidin_density_ridge.png){#fig-2}

![Stacked barplots of Saidin Index scores by year](task1/figures/saidin_boxplot.png){#fig-3}

A period of rapid relative growth looks to have occurred between 2002 and 2005 (@fig-3), starting in 2003 (@fig-2), the same year that the Medicare Modernization Act (MMA) was initiated. However, this rapid growth has since slowed, with growth between 2007 and 2010 becoming increasingly limited. 

It is also important to note that the scores have not shifted uniformly; rather, their distribution has become more spread out, with a large number of outliers developing on the higher end (better technology availability). Should these outliers correlate with those hospitals receiving MMA treatment, the data would suggest ***support for the intervention's positive impact***. 

:::

#### Part B

::: {.callout-note collapse=true icon=false}
## CODE FOR REPRODUCIBILITY

```{r, eval = FALSE}
# create independent type variable
mma_types_2004 <- mma_2004 |> 
  mutate(
    hospital_type = case_when(
      nonprof == 1 & govt == 0 ~ "nonprof",
      govt == 1 & nonprof == 0 ~ "govt",
      govt == 0 & nonprof == 0 ~ "neither",
      TRUE ~ NA_character_
    )
  )

# assuming normality due to sample size
# one-way ANOVA
anova_types <- aov(saidin ~ hospital_type, data = mma_types_2004)
summary(anova_types)

# Tukey's test
TukeyHSD(anova_types)
```

:::

![Density plots of Saidin scores by hospital type in 2004](task1/figures/plot_types_2004.png){#fig-4}

Since the analysis was limited to 2004, I operationalize "rates of technology adoption" as the Saidin scores for that year. An initial density plot of Saidin scores by hospital type (i.e., nonprofit, government, neither) visualizes significant differences between non-profit hospitals and both other types. Government hospitals and hospitals that are neither non-profit nor government do not seem to differ much from each other.

To investigate if technology adoption rates were significantly different between the hospital types, I conduct a one-way ANOVA with the null hypothesis that the true difference in Saidin scores between hospital types is zero.

::: {.callout-note icon=false appearance="simple"}

# ANOVA Results
```{r, echo = FALSE}
mma_types_2004 <- mma_2004 |> 
  mutate(
    hospital_type = case_when(
      nonprof == 1 & govt == 0 ~ "nonprof",
      govt == 1 & nonprof == 0 ~ "govt",
      govt == 0 & nonprof == 0 ~ "neither",
      TRUE ~ NA_character_
    )
  )
anova_types <- aov(saidin ~ hospital_type, data = mma_types_2004)
summary(anova_types)
```

:::

::: {.callout-note icon=false appearance="simple"}
```{r, echo = FALSE}
TukeyHSD(anova_types)
```
::: 

**Results:** There was a *statistically significant difference* in residuals between at least two of the hospital types (*F*(2, 203) = 25.96, *p* < 0.001). 

As we anticipated from @Fig-3,[^2] Tukeyâ€™s HSD Test for multiple comparisons *confirmed* that there was a statistically significant difference between both **nonprofit and government** types (*p* < 0.001, 95% CI [0.440, 1.071]) and **nonprofit and neither** types (*p* < 0.001, 95% CI [0.536, 1.312]) but no statistically significant difference between **government and neither** types (*p* = 0.650, 95% CI [-0.614, 0.278]).

These results suggest that nonprofit hospitals have different (higher) rates of technology adoption than government hospitals or hospitals that are neither, implying the possibility for government hospital technology improvement. 

[^2]: In the Additional Exploratory Analysis callout in Part A

#### Part C

::: {.callout-note collapse=true icon=false}
## CODE FOR REPRODUCIBILITY

```{r, eval = FALSE}
# linear regression model
lm_beds <- lm(saidin ~ beds, data = mma_2004)
summary(lm_beds)
confint(lm_beds)
```

:::

![Scatterplot of Saidin scores and beds in 2004](task1/figures/plot_beds_2004.png){#fig-5}

An initial scatterplot of Saidin scores and beds in 2004 (i.e., nonprofit, government, neither) visualizes a positive correlation between hospital size and technological capacity.

Simple linear regression analysis was used to test if the number of beds explained variation in Saidin index scores.

::: {.callout-note icon=false appearance="simple"}

# Linear Regression Results
```{r, echo = FALSE}
# linear regression model
lm_beds <- lm(saidin ~ beds, data = mma_2004)
summary(lm_beds)
confint(lm_beds)
```

:::

**Results**: A *significant* regression was found (*F*(1, 1303) = 900.8, *p* < 0.001). The R^2 value of **0.408** indicates that the predictor (`beds`) explained about 40.8% of the variation in Saidin index scores. We can be 95% certain that the true change in Saidin scores as a function of the number of beds is between **5.90e-3 and 6.73e-3**, suggesting a positive correlation.

These results support the idea that the more beds a hospital has, the higher their Saidin scores tend to be, suggesting there is a positive relationship between hospital capacity and technological availability. Hospital capacity could be an indicator of greater access to resources, which lends to higher rates of technology adoption.

### Exercise 4

::: {.callout-note collapse=true icon=false}
## CODE FOR REPRODUCIBILITY

```{r, eval = FALSE}
# event study model
did_event <- 
  feols(saidin ~ i(year, treat, ref = 2004) | prov_id + year, data = mma_data)

# table of estimates and CI
did_estimates <- summary(did_event)
did_ci <- confint(did_event)

did_estimates_ci <- did_estimates$coefficients |>
  as.data.frame() |>
  tibble::rownames_to_column("year") |>
  left_join(
    as.data.frame(did_ci) |>
      tibble::rownames_to_column("year") |>
      rename(),
    by = join_by(year)
  ) |>
  janitor::clean_names() |>
  rename(
    tr_effect = did_estimates_coefficients,
    tr_hi = x97_5_percent,
    tr_lo = x2_5_percent
  ) |>
  mutate(year = as.numeric(str_extract(year, "\\d{4}")))

# table of means
did_means <- mma_data |>
  group_by(year) |>
  filter(treat == 0) |>
  summarize(mean(saidin)) |>
  rename(cr_mean = `mean(saidin)`) |>
  left_join(
    mma_data |>
      group_by(year) |>
      filter(treat == 1) |>
      summarize(mean(saidin)) |>
      rename(tr_mean = `mean(saidin)`)
  )

# joins tables into new dataset
mma_did <- did_estimates_ci |>
  left_join(did_means)

```

:::

```{r, echo=FALSE}
library(gt)
load(file = here("task1/data/mma_did.rds"))
mma_did |> 
  gt(rowname_col = "year") |> 
  tab_header(
    title = md("Effect of MMA on adoption of medical technologies"), 
    subtitle = md("Estimates from <b style='color: #F8766D;'>fixest::feols()</b> with <b/>95% CI</b>")
  )
```

The `fixest::feols()` function was used to estimate a fixed effects linear regression model with clustered standard errors as part of a difference-in-difference analysis, to estimate the effect (`tr_effect`) of receiving a Section 508 waiver on the adoption of medical technologies with 95% confidence interval bounds (`tr_lo`, `tr_hi`). 

Mean Saidin index scores were calculated for the control group (`cr_mean`) and treatment group (`tr_mean`) in each year.

### Exercise 5

### Exercise 6

## Task 2
