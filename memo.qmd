---
title: "Tobin Predoctoral Data Task"
subtitle: "Experiments to Enhance the Efficiency of Medicaid"
author: "Sheena Tan"

date: today

format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    embed-resources: true
    code-fold: false
    link-external-newwindow: true

execute:
  warning: false
  
from: markdown+emoji
reference-location: margin
citation-location: margin
---

::: {.callout-tip icon="false"}
## Github Repo Link

<https://github.com/sheena-tan/tobintask.git>
:::

# Introduction

This project uses data provided by Yale's Tobin Center for Economic Policy as part of a data task for a pre-doctoral research position. The data draws from a larger research project aiming to understand hospital response to reimbursement rate adjustment received as part of the Medicare Modernization Act (MMA) of 2003, and whether their adoption of medical technologies increased as a result of those adjustments for Task 1. Task 2 uses data... TKTK ...

## Task 1

### Exercise 1

```{r, eval = FALSE}
skimr::skim(mma_main)
skimr::skim(mma_treat)
# check missingness: n_missing = 0 for all variables
# check duplicates: n_unique = 1305 for both datasets

# Clean primary key ----
mma_main_join <- mma_main |>
  mutate(prov_id = tolower(prov_id))

mma_treat_join <- mma_treat |>
  mutate(prov_id = tolower(prov_id))

# Join data ----
mma_data <- mma_treat_join |>
  left_join(mma_main_join)

```

An initial inspection of the data revealed no missingness. The provided data files were joined using provider ID as a primary key, resulting in a merged dataset with 13050 unique observations of 38 variables.

### Exercise 2

```{r, eval = FALSE}
mma_data |>
  group_by(year) |>
  mutate(prov_total = n_distinct(prov_id)) |>
  skimr::skim(prov_total)
# N_t each year [2001-2010] constant = 1305

# create intermediate index variable before sum for all `tech_n`
for (i in 1:31) {
  mma_saidin <- mma_saidin |>
    group_by(year) |>
    mutate(
      # number of hospitals with tech_n
      !!paste0("sum_", i) := sum(!!sym(paste0("tech_", i))), 
      # weight a_k,t
      !!paste0("weight_", i) := 1 - (1/1305) * !!sym(paste0("sum_", i)), 
      !!paste0("index_", i) := 
        !!sym(paste0("tech_", i)) * !!sym(paste0("weight_", i))
    )
}

# sum across `index_n` to find saidin index for each hospital per year
mma_saidin <- mma_saidin |>
  pivot_longer(cols = starts_with("index"), names_to = "index") |>
  group_by(prov_id, year) |>
  summarise(sum(value)) |>
  rename(saidin = `sum(value)`)

# join to merged data
mma_data <- mma_saidin |>
  left_join(mma_data)

```

A variable `saidin` was constructed to represent the Saidin Index Score[^1] for all hospitals in each year and joined with the merged dataset to create the working dataset with **13050 observations** of **39 variables**. This index characterizes a hospital's range of available technologies, weighted for their rarity, and provides a way through which to investigate how hospital technology grows and changes, particularly in response to interventions.

[^1]: Baker, L. & Spetz, J. (1999). Managed care and medical technology growth. *Frontiers in Health
Policy Research, 2*, 31.

### Exercise 3

#### Part A

```{r, eval = FALSE}
mma_2004 <- mma_data |> 
  filter(year == 2004)

describe(mma_2004$saidin, IQR = TRUE, skew = FALSE)
```

```{r, echo = FALSE}
library(psych)
library(dplyr)
library(here)
load(here("task1/data/mma_data.rds"))
mma_2004 <- mma_data |> 
  filter(year == 2004)
describe(mma_2004$saidin, IQR = TRUE, skew = FALSE)
```

The distribution of Saidin Index scores in 2004 is strongly right-skewed, with values ranging from **0 to 11.57**, a **median of 1.19**, and an **IQR of 1.84**. 

![Density-boxplot of Saidin Index scores in 2004](task1/figures/saidin_2004.png){#fig-1}

As the Saidin Index is helpful for characterizing technology growth rates, the distributions by year can also be found below:

::: {.callout-tip collapse=true}
## ADDITIONAL EXPLORATORY ANALYSIS

![Density ridge plot of Saidin Index scores by year](task1/figures/saidin_density_ridge.png){#fig-2}

![Stacked barplots of Saidin Index scores by year](task1/figures/saidin_boxplot.png){#fig-3}

A period of rapid relative growth looks to have occurred between 2002 and 2005 (@fig-3), starting in 2003 (@fig-2), the same year that the Medicare Modernization Act (MMA) was initiated. However, this rapid growth has since slowed, with growth between 2007 and 2010 becoming increasingly limited. 

It is also important to note that the scores have not shifted uniformly; rather, their distribution has become more spread out, with a large number of outliers developing on the higher end (better technology availability). Should these outliers correlate with those hospitals receiving MMA treatment, the data would suggest ***support for the intervention's positive impact***. 

:::

#### Part B

```{r, eval = FALSE}
# create independent type variable
mma_types <- mma_data |> 
  mutate(
    hospital_type = case_when(
      nonprof == 1 & govt == 0 ~ "nonprof",
      govt == 1 & nonprof == 0 ~ "govt",
      govt == 0 & nonprof == 0 ~ "neither",
      TRUE ~ NA_character_
    )
  )

# limit analysis to 2004
mma_types_2004 <- mma_types |> filter(year == 2004)

# assuming normality due to sample size
# one-way ANOVA
anova_types <- aov(saidin ~ hospital_type, data = mma_types_2004)
summary(anova_types)

# Tukey's test
TukeyHSD(anova_types)
```

![Density plots of Saidin scores by hospital type in 2004](task1/figures/plot_types_2004.png){#fig-4}

Since the analysis was limited to 2004, I operationalize "rates of technology adoption" as the Saidin scores for that year. An initial density plot of Saidin scores by hospital type (i.e., nonprofit, government, neither) visualizes significant differences between non-profit hospitals and both other types. Government hospitals and hospitals that are neither non-profit nor government do not seem to differ much from each other.

To investigate if technology adoption rates were significantly different between the hospital types, I conduct a one-way ANOVA with the null hypothesis that the true difference in Saidin scores between hospital types is zero.

```{r, echo = FALSE}
mma_types <- mma_data |> 
  mutate(
    hospital_type = case_when(
      nonprof == 1 & govt == 0 ~ "nonprof",
      govt == 1 & nonprof == 0 ~ "govt",
      govt == 0 & nonprof == 0 ~ "neither",
      TRUE ~ NA_character_
    )
  )
mma_types_2004 <- mma_types |> filter(year == 2004)
anova_types <- aov(saidin ~ hospital_type, data = mma_types_2004)
summary(anova_types)
TukeyHSD(anova_types)
```

**Results:** There was a *statistically significant difference* in residuals between at least two of the hospital types (*F*(2, 203) = 25.96, *p* < 0.001). 

As seen in @Fig-3, Tukeyâ€™s HSD Test for multiple comparisons *confirmed* that there was a statistically significant difference between both **nonprofit and government** types (*p* < 0.001, 95% CI [0.440, 1.071]) and **nonprofit and neither** types (*p* < 0.001, 95% CI [0.536, 1.312]) but no statistically significant difference between **government and neither** types (*p* = 0.650, 95% CI [-0.614, 0.278]).

These results suggest that nonprofit hospitals have different (higher) rates of technology adoption than government hospitals or hospitals that are neither, implying the possibility for government hospital technology improvement. 

#### Part C

Do hospitals with more beds tend to have higher Saidin index scores?


### Exercise 4

### Exercise 5

### Exercise 6

## Task 2
